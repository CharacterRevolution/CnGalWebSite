@inject HttpClient Http
@inject IDataCacheService _dataCacheService


<div>
    @foreach (var examine in pagedResultDto.Data)
    {
        <div class="rounded shadow-sm  bg-opacity mb-3 p-3">
            <div style="display: flex; align-items: center;">
                <div>
                    @if (examine.IsPassed != null)
                    {
                        if (examine.IsPassed == true)
                        {
                            <MIcon Color="success">mdi-checkbox-marked-circle-outline</MIcon>
                        }
                        else
                        {
                            <MIcon Color="error">mdi-alert-circle </MIcon>
                        }
                    }
                    else
                    {
                        <MIcon Color="warning">mdi-history</MIcon>
                    }
                </div>
                <div class="ms-3">
                    @{ string name = "";}
                    @if (examine.Type == ExaminedNormalListModelType.Entry)
                    {
                        name = " entries";

                    }
                    else if (examine.Type == ExaminedNormalListModelType.Article)
                    {
                        name = " articles";

                    }
                    else if (examine.Type == ExaminedNormalListModelType.Tag)
                    {
                        name = " tags";

                    }
                    else if (examine.Type == ExaminedNormalListModelType.Disambig)
                    {
                        name = " disambigs";

                    }
                    else if (examine.Type == ExaminedNormalListModelType.Periphery)
                    {
                        name = " peripheries";

                    }


                    @if (examine.Type == ExaminedNormalListModelType.Comment)
                    {
                        <span>
                            @($"序号『{ examine.Id.ToString("00000")}』")
                            <TabLink Text="@name" Url="@("/home/examined/"+examine.Id)" Icon="fa fa-pencil">
                                @examine.Operation.GetDisplayName()
                            </TabLink>
                        </span>
                    }
                    else
                    {
                        <span>
                            对
                            @($"『{ examine.Id.ToString("00000")}』")
                            <TabLink Text="@examine.RelatedName" Url="@(name+"/index/"+examine.RelatedId)" Icon="fa fa-codepen">
                                @(string.IsNullOrWhiteSpace(examine.RelatedName) ?("Id："+ examine.RelatedId) : examine.RelatedName )
                            </TabLink>
                            进行
                            <TabLink Text="@name" Url="@("/home/examined/"+examine.Id)" Icon="fa fa-pencil">
                                @examine.Operation.GetDisplayName()
                            </TabLink>
                            操作
                        </span>
                    }

                    <br />
                    <span style="color:gray;">
                        @("申请时间："+examine.ApplyTime.ToString("yyyy-MM-dd HH:mm")) &nbsp; &nbsp;
                        @if (examine.PassedTime != null)
                        {
                            @("审核时间："+examine.PassedTime.Value.ToString("yyyy-MM-dd HH:mm"))
                        }

                    </span>
                </div>
            </div>
        </div>
    }
    @if (pagedResultDto.TotalPages > 1)
    {
        <MPagination Value="@pagedResultDto.CurrentPage" Class="my-4" Length="@pagedResultDto.TotalPages" ValueChanged="OnPageClick" Color="@_dataCacheService.ThemeSetting.Theme" TotalVisible="7"></MPagination>
    }
</div>


@code {
    [CascadingParameter]
    public ErrorHandler ErrorHandler { get; set; }

    [Parameter]
    public string Id { get; set; }

    public PagedResultDto<ExaminedNormalListModel> pagedResultDto = new CnGalWebSite.DataModel.Application.Dtos.PagedResultDto<ExaminedNormalListModel>();

    protected override async Task OnInitializedAsync()
    {
        //获取审核列表
        await OnPageClick(1);
    }

    private async Task OnPageClick(int pageIndex)
    {
        try
        {
            var result = await Http.PostAsJsonAsync<GetExamineInput>(ToolHelper.WebApiPath + "api/space/GetUserEditRecord", new GetExamineInput
            {
                UserId = Id,
                Sorting = "Id desc",
                MaxResultCount = 10,
                CurrentPage = pageIndex
            });
            string jsonContent = result.Content.ReadAsStringAsync().Result;
            pagedResultDto = JsonSerializer.Deserialize<PagedResultDto<ExaminedNormalListModel>>(jsonContent, ToolHelper.options);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorHandler.ProcessError(ex, "获取编辑记录失败");
        }
    }
    private async Task OnPageItemsChanged(int pageItems)
    {
        try
        {
            var result = await Http.PostAsJsonAsync<GetExamineInput>(ToolHelper.WebApiPath + "api/space/GetUserEditRecord", new GetExamineInput
            {
                UserId = Id,
                Sorting = "Id desc",
                MaxResultCount = pageItems,
                CurrentPage = pagedResultDto.CurrentPage
            });
            string jsonContent = result.Content.ReadAsStringAsync().Result;
            pagedResultDto = JsonSerializer.Deserialize<PagedResultDto<ExaminedNormalListModel>>(jsonContent, ToolHelper.options);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorHandler.ProcessError(ex, "获取编辑记录失败");
        }
    }
}
