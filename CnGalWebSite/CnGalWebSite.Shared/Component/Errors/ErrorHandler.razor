@using Microsoft.Extensions.Logging

@inject ToastService ToastService
@inject ILogger<ErrorHandler> Logger
@inject IJSRuntime JS

<CascadingValue Value=this>
    @ChildContent
</CascadingValue>

@code {
    [Parameter]
    public RenderFragment ChildContent { get; set; }

    private DateTime LastErrorTime { get; set; } = DateTime.Now.ToCstTime().AddYears(-1);

    public async void ProcessError(Exception ex, string message = "", string reason = "服务器网络异常", string resolvent = "")
    {
        Logger.LogError("Error:ProcessError - Type: {Type} Message: {Message}",
            ex.GetType(), ex.Message);
        //向友盟发送日志
        try
        {
            await JS.InvokeAsync<string>("trackEvent", "抛出异常", message, ex.Message, "1", "look");
        }
        catch (Exception exc)
        {

        }

        //向用户发送通知
        var time = (DateTime.Now.ToCstTime() - LastErrorTime).TotalSeconds;
        if (time > 2 && string.IsNullOrWhiteSpace(message) == false)
        {
            if (string.IsNullOrWhiteSpace(resolvent))
            {
                var qq = "761794704";
                var qqUrl = "https://jq.qq.com/?_wv=1027&k=q0DBI011";
                resolvent = $"检查网络是否正常，按下Ctrl + F5 刷新网页缓存，加群 <a href='{qqUrl}'>{qq}</a> 反馈Bug";
            }
            if(ToastService!=null)
            {
                await ToastService.Show(new ToastOption
                {
                    Title = message,
                    IsAutoHide = true,
                    Category = ToastCategory.Error,
                    Delay = 20000,
                    ForceDelay = true,
                    Content = $"<div class='mb-2'>报错：{ex.Message}</div><div  class='mb-2'>可能原因：{reason}</div><div>解决方法：{resolvent}</div>",
                });

            }


            LastErrorTime = DateTime.Now.ToCstTime();
        }

    }
}
