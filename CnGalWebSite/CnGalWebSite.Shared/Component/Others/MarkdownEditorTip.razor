@inject IJSRuntime JS
@inject HttpClient Http
@inject ExamineService _examineService
@inject ILocalStorageService _localStorage
@inject ToastService? ToastService
@inject IAppHelper _appHelper
@inject IServiceProvider Provider
@inject NavigationManager NavigationManager

<link rel="stylesheet" href="https://app.cngal.org/_content/BootstrapBlazor.Markdown/css/bootstrap.blazor.markdown.min.css" media="none" onload="this.media='all'" />
<link rel="stylesheet" href="https://app.cngal.org/_content/CnGalWebSite.Shared/editor.md/css/editormd.min.css" media="none" onload="this.media='all'" />

<div>
    @if (ToolHelper.IsSSR)
    {
        <AlertTip Type="AlertTip.AlertTipType.MarkdownTip"></AlertTip>

    }
    <ImagesUploadViewTip images="images" OnUploadedImage="OnUploadImage"></ImagesUploadViewTip>
    <div class="alert alert-success  rounded shadow-sm  rounded mb-4" role="alert" style="margin:0px">
        不了解Markdown？可以在这<a href="http://www.markdown.cn/" target="_blank" class="alert-link">查看语法说明</a>
    </div>
    @if (isReady)
    {
            <EditorMdViewTip Context="@Context" @ref="markdownEditorTip" ContextChanged="ContextValueChanged"></EditorMdViewTip>
    }

</div>

@code {
    [Parameter]
    public string Context { get; set; }
    [Parameter]
    public EventCallback<string> ContextChanged { get; set; }
    [NotNull]
    private EditorMdViewTip? markdownEditorTip;
    bool isReady = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ToolHelper.IsSSR == false)
        {
            isReady = true;
            //获取主页中原有的图片
            if (string.IsNullOrWhiteSpace(Context) == false)
            {
                var temp = ToolHelper.GetImageLinks(Context);

                images.Clear();
                foreach (var item in temp)
                {
                    images.Add(new ImagesUploadAloneModel
                    {
                        ImagePath = item,
                        Image = item
                    });
                }
            }
            StateHasChanged();
        }
    }


    public async Task<string> GetContext()
    {
        if (isTextOnly)
        {
            Context = await markdownEditorTip.GetContext();
            await ContextChanged.InvokeAsync(Context);
        }
        return Context;
    }

    public List<ImagesUploadAloneModel> images = new List<ImagesUploadAloneModel>();

    bool isTextOnly = false;

    public async Task ContextValueChanged(string text)
    {
        Context = text;
        await ContextChanged.InvokeAsync(Context);
    }

    public async Task OnClickTextOnly()
    {
        if (isTextOnly)
        {
            Context = await markdownEditorTip.GetContext();
        }
        isTextOnly = !isTextOnly;
        await ContextChanged.InvokeAsync(Context);
        StateHasChanged();
    }

    public async Task OnUploadImage(string url)
    {
        if (isTextOnly)
        {
            Context = await markdownEditorTip.GetContext();
        }
        //更新字符串
        string temp = ("\n![image](" + url + ")\n");
        Context += temp;
        if (isTextOnly)
        {
            await markdownEditorTip.AddContext(temp);
        }
        await ContextChanged.InvokeAsync(Context);
        StateHasChanged();
    }
}
