# API使用流程概述

## 内容目录

<details open="open">
  <summary>点我 打开/关闭 目录列表</summary>

- [API使用流程概述](#api使用流程概述)
  - [内容目录](#内容目录)
  - [简介](#简介)
  - [审核（编辑记录）](#审核编辑记录)
  - [词条](#词条)
  - [标签](#标签)
  - [文章](#文章)
  - [周边](#周边)
  - [消歧义页](#消歧义页)
  - [收藏夹](#收藏夹)
  - [用户、账号](#用户账号)
  - [综述](#综述)

</details>

<span id="nav-1"></span>

## 简介

- 文档会按照业务流程讲解大部分API调用顺序及方法
- 所有API请参阅 [Swagger文档](https://www.cngal.org/swagger/index.html)
- 文档中只会提及关键参数，请配合Swagger文档查阅参数
- 我们努力使文档与最新API使用方法保持一致，如实测有误，请以API返回数据为准，同时欢迎提交PR修改文档错误
- 关于API具体代码实现逻辑，请参阅 [接口实现概述]()
- 后文是对每个模块的使用概述，你也可以查看每个模块的详细API文档：[账号](Account.md)、[词条]()、[文章]()、

<span id="nav-2"></span>

## 审核（编辑记录）

* 所有编辑都要经过审核模块
* 各个模块都有不同的审核板块，即审核类别
* 每个审核版块的状态相互独立，可以单独通过或驳回
    * **预览**：用户已经编辑该版块，当前正在等待审核。可以重新编辑，之后会覆盖原审核请求
    * **锁定**：其他用户已经编辑该版块，当前正在等待审核，不可编辑（即使是管理员也不可）
    * **正常**：当前没有被编辑，可以编辑
* 用户可以撤销审核请求，撤销后会清除所有相关数据
* 审核请求 来实现**编辑记录**和**用户编辑记录**。当审核通过后会自动对用户发放相应的奖励
> 第三方客户端开发者请注意：编辑时不会修改版块状态，也就是说可能会有两个用户同时编辑一个版块，先提交的用户编辑会生效，后提交的用户会收到一个错误提示。如果你想要避免这个问题，请在用户进入编辑页面时，立即发送一个**审核**请求，此时版块会进入预览状态，之后用户的真实修改会覆盖**审核**请求，就像什么都没发生过一样。

<span id="nav-3"></span>

## 词条

* 用户可以自由创建编辑**词条**
* 词条可以分为游戏，角色，staff，制作组四大类别，每一个词条都可以附加 **标签** 来进一步分类
* 词条分为六个版块（主要信息，附加信息，标签，主页，图片，关联信息）
* 用户创建**词条**后会按照板块分为最多六个 **审核** 请求等待处理
* 在词条中上传的图片会记录到用户的文件列表中，每个用户拥有500MB的空间存放文件

> 注意：在词条中删除图片并不会真实删除图片，只会消除图片引用

* 主页使用Markdown语法渲染，由于浏览器性能限制，强烈建议使用链接引用图片，而不是使用base64内嵌图片，我们很可能不会通过内嵌图片的审核
* 词条采用名称关联，会在运行时动态查找关联词条。如果修改词条名称，关联信息将会失效，需要手动重新添加
* 词条显示的角色、游戏、外部链接等关联信息，实际上同属于关联部分，没有分开储存

<span id="nav-4"></span>

## 标签

* 标签分为三个板块：主要信息，子标签，子词条
* 有四个顶级标签：游戏、角色、STAFF、制作组
* 标签拥有层级关系，除顶级标签外，每个标签都有父标签
* 子词条和子标签都使用Id关联
* 一般二级标签不包含关联词条，例如

> 游戏->按时长分->短篇<br>
> 角色->按性格分->傲娇<br>
> 角色->按身材分->萝莉<br>
> STAFF->按职位分->CV

<span id="nav-5"></span>

## 文章

* 所以用户都可以发布文章：动态、访谈、攻略、感想、其他
* 虽然文章分为主要信息和主页两大板块，但实际中会合并为一个EditArticle接口调用
* 类别为动态的文章被词条关联后会按 **真实发生时间** 逆序显示在时间线中，动态如果存在外链的原文，点击会直接跳转到外链
* 只有管理员可以发布公告
* 文章不同于词条，只有发布它的用户和管理员才能编辑，其他和词条大致相同

<span id="nav-6"></span>

## 周边

* 周边分为：主要信息，关联周边，关联词条
* 周边必须关联一个词条，用于查找该周边
* 会将关联同一个词条的周边以合集的方式展示
* 允许用户记录对某个周边的收集状态，会以合集为单位统计收集进度

<span id="nav-7"></span>

## 消歧义页

* 虽然分为主要信息和关联信息，但编辑时会整合成一次接口调用
* 允许关联词条和文章，被关联的词条文章会在页面上方显示提示

<span id="nav-8"></span>

## 收藏夹

* 每个用户会自动创建一个默认收藏夹
* 允许用户创建，修改，删除收藏夹
* 可以批量移动收藏夹的内容到其他收藏夹
* 收藏时，如果有被设置为默认的收藏夹则会自动收藏，如果没有则弹窗提示用户选择收藏夹
* 收藏夹仅自己可见

<span id="nav-9"></span>

## 用户、账号

* 使用JWT令牌作为安全方案，具体使用方式参阅 [设置请求头]()
* 进行修改密码等敏感操作时需要进行二次身份验证，需要提前调用二次身份验证接口，请参阅 [二次身份验证]()
* 登入、注册、发送验证码接口有人机验证，需要先调用极验验证接口，请参阅 [人机验证说明]()
* 旧版网站的历史用户在第一次登入后会将用户名与昵称合并，后续只能使用昵称或邮箱登入
* 允许使用QQ、Gitee第三方账户登入
* 用户的周边，编辑记录，资料，文章是公开信息；收藏夹，签到记录是私有信息

<span id="nav-10"></span>

## 综述

* 建议使用细分的API获取为对应页面处理过的简化数据
* 调用API时尽可能地带上身份信息
* 单个IP对单个API的请求按不同时段有上限次数，请不要滥用API接口
* 审核的BeforeData和AfterData字段是动态模型，需要根据审核类型动态匹配
* 词条的Information模型比较复杂，虽然可以在此基础上提供自定义信息，但是由于目前网站还未适配无法识别的数据编辑操作，将导致自定义数据在其他用户编辑后被删除，因此不建议使用自定义数据

